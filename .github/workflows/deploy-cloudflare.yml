# Auto-generated by Flowglass - Cloudflare Worker Deployment
# Worker: test
# Project ID: ad53fae6-a2a6-4ce0-bc5d-0345e5549718
# Live URL: Will be available after first deployment

name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - preview

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Worker
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: "npm"

      - name: Install dependencies
        run: |
          echo "::group::Installing dependencies"
          if [ -f "package-lock.json" ]; then
            npm ci
          elif [ -f "package.json" ]; then
            npm install
          else
            echo "::notice::No package.json found, skipping dependency installation"
          fi
          echo "::endgroup::"

      - name: Run tests
        run: |
          if [ -f "package.json" ] && grep -q "\\"test\\":" package.json; then
            npm test || echo "::warning::Tests failed but continuing deployment"
          else
            echo "::notice::No tests configured"
          fi

      - name: Build application
        run: |
          echo "::group::Building application"
          if [ -f "package.json" ] && grep -q '"\\"build\\":' package.json; then
            npm run build
          else
            echo "::notice::No build script found in package.json"
          fi
          echo "::endgroup::"

      - name: Install Wrangler
        run: npm install -g wrangler@latest

      - name: Create deployment
        id: deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: context.inputs?.environment || "production",
              description: "Cloudflare Workers deployment",
              auto_merge: false,
              required_contexts: []
            });
            core.setOutput("deployment_id", deployment.data.id);

      - name: Validate worker code
        id: validate
        run: |
          echo "::group::Validating worker code"
          # Check for wrangler.toml first (most reliable)
          if [ -f "wrangler.toml" ]; then
            echo "Found wrangler.toml configuration"
            MAIN_ENTRY=$(grep -E '^main\\s*=' wrangler.toml | sed 's/.*=\\s*"\\(.*\\)"/\\1/' | head -1)
            if [ -n "$MAIN_ENTRY" ]; then
              echo "Entry point from wrangler.toml: $MAIN_ENTRY"
            fi
          fi
          
          # Check for various entry points
          if [ ! -f "index.js" ] && [ ! -f "index.ts" ] && [ ! -f "src/index.js" ] && [ ! -f "src/index.ts" ] && \\
             [ ! -f "workers/app.ts" ] && [ ! -f "workers/app.js" ] && [ ! -f "dist/index.js" ] && \\
             [ ! -f "build/index.js" ] && [ -z "$MAIN_ENTRY" ]; then
            echo "::error::No worker entry point found. Checked: index.js, index.ts, src/index.js, src/index.ts, workers/app.ts, workers/app.js, dist/index.js, build/index.js"
            echo "::error::Also checked wrangler.toml for main entry configuration"
            exit 1
          fi
          echo "::endgroup::"

      - name: Deploy to Cloudflare Workers
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: 6ec57290cbb52c27cda0bd089bae05a0
        run: |
          set -e
          ENVIRONMENT="${{ github.event.inputs.environment || 'production' }}"
          WORKER_NAME="test"
          
          if [ "$ENVIRONMENT" = "preview" ]; then
            WORKER_NAME="${WORKER_NAME}-preview"
          fi
          
          echo "::notice::Deploying to $WORKER_NAME ($ENVIRONMENT environment)"
          
          # Deploy with wrangler
          # Check if wrangler.toml exists to determine deployment method
          if [ -f "wrangler.toml" ]; then
            echo "::notice::Using wrangler.toml configuration"
            wrangler deploy 2>&1 | tee deploy.log
          else
            echo "::notice::No wrangler.toml found, using CLI arguments"
            wrangler deploy --name "$WORKER_NAME" --compatibility-date $(date +%Y-%m-%d) 2>&1 | tee deploy.log
          fi
          
          # Extract URL from deployment
          DEPLOYED_URL=$(grep -oP "https://[a-zA-Z0-9.-]+\\.workers\\.dev" deploy.log | head -1 || echo "")
          if [ -n "$DEPLOYED_URL" ]; then
            echo "url=$DEPLOYED_URL" >> $GITHUB_OUTPUT
            echo "::notice::Worker deployed to $DEPLOYED_URL"
          else
            echo "::warning::Could not extract deployment URL"
          fi

      - name: Update deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentId = ${{ steps.deployment.outputs.deployment_id }};
            const state = ${{ steps.deploy.outcome }} === "success" ? "success" : "failure";
            const environment = context.inputs?.environment || "production";
            const deploymentUrl = "${{ steps.deploy.outputs.url }}" || null;
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deploymentId,
              state: state,
              environment_url: deploymentUrl,
              description: state === "success" ? "Deployment successful" : "Deployment failed",
              auto_inactive: true
            });

      - name: Create summary
        if: always()
        run: |
          echo "## Cloudflare Workers Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Worker Name:** ${{ env.WORKER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.deploy.outcome }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.deploy.outputs.url }}" ]; then
            echo "**URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
